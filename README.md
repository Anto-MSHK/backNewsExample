# Новостной API

API для новостного сайта с использованием NestJS и PostgreSQL.

## Описание

Backend-сервер для новостного сайта. Сервер предоставляет API для управления новостями, категориями, агентствами и пользователями с разными ролями.

## Технологический стек

- NestJS (TypeScript)
- TypeORM (для работы с PostgreSQL)
- PostgreSQL (как база данных)
- JWT для аутентификации

## Структура базы данных

1. **Agency (Агентство):**

   - Одно агентство может иметь много пользователей и много новостей.

2. **User (Пользователь):**

   - Роли пользователя: Reader (Читатель), Author (Автор) или Admin (Администратор).
   - Пользователь может принадлежать к одному агентству.

3. **Category (Категория новостей):**

   - Одна категория может иметь много новостей.

4. **News (Новость):**
   - Новость принадлежит одному Автору, одному Агентству и одной Категории.

## Установка и запуск

### Требования

- Node.js (18+)
- Docker и Docker Compose (для запуска PostgreSQL)

### Шаги по запуску

1. Клонировать репозиторий:

```bash
git clone <url_репозитория>
cd <адрес репозитория>
```

2. Установить зависимости:

```bash
npm install
```

3. Инициализировать базу данных начальными данными:

```bash
npm run seed
```

4. Запустить сервер в режиме разработки:

```bash
npm run start:dev
```

Сервер будет доступен по адресу http://localhost:3000/api

## Тестовые учетные записи

После запуска скрипта инициализации данных (seed) будут созданы следующие учетные записи:

- **Администратор**:

  - Логин: admin
  - Пароль: admin123

- **Авторы**:
  - Логин: author1, Пароль: password1
  - Логин: author2, Пароль: password2
  - Логин: author3, Пароль: password3

## API Endpoints

### Аутентификация

- `POST /api/auth/login` - Аутентификация пользователя

### Пользователи

- `POST /api/users` - Создание нового пользователя (только для админов)
- `GET /api/users/:id` - Получение информации о пользователе (только для админов)

### Агентства

- `GET /api/agencies` - Получение списка всех агентств
- `GET /api/agencies/:id` - Получение информации об агентстве
- `POST /api/agencies` - Создание нового агентства (только для админов)
- `PATCH /api/agencies/:id` - Обновление данных агентства (только для админов)
- `DELETE /api/agencies/:id` - Удаление агентства (только для админов)

### Категории

- `GET /api/categories` - Получение списка всех категорий
- `GET /api/categories/:id` - Получение информации о категории
- `POST /api/categories` - Создание новой категории (только для админов)
- `PATCH /api/categories/:id` - Обновление данных категории (только для админов)
- `DELETE /api/categories/:id` - Удаление категории (только для админов)

### Новости

- `GET /api/news` - Получение списка всех новостей (с возможностью фильтрации)
- `GET /api/news/:id` - Получение информации о новости
- `POST /api/news` - Создание новой новости (для авторов и админов)
- `PATCH /api/news/:id` - Обновление данных новости (для авторов - только своих новостей, для админов - любых)
- `DELETE /api/news/:id` - Удаление новости (для авторов - только своих новостей, для админов - любых)

## Фильтрация новостей

При запросе `GET /api/news` можно использовать следующие параметры для фильтрации:

- `categoryId` - ID категории для фильтрации новостей
- `agencyId` - ID агентства для фильтрации новостей
- `startDate` - Новости, опубликованные после этой даты (формат ISO)
- `endDate` - Новости, опубликованные до этой даты (формат ISO)
- `sourceType` - Тип источника новостей:
  - `local` - только локальные новости
  - `external` - только внешние новости из NewsAPI
  - `all` - все новости (по умолчанию)

## Интеграция с NewsAPI

Приложение интегрировано с внешним сервисом NewsAPI для получения актуальных новостей. Внешние новости автоматически помечаются специальными полями и могут быть отфильтрованы от локальных новостей.

### Настройка NewsAPI

1. Получите API ключ на https://newsapi.org
2. Создайте файл `.env` на основе `.env.example`:

```bash
cp .env.example .env
```

3. Добавьте ваш API ключ в файл `.env`:

```env
NEWS_API_KEY=your_actual_newsapi_key_here
```

### Особенности внешних новостей

Внешние новости из NewsAPI имеют следующие дополнительные поля:

- `isExternal: true` - пометка о том, что новость внешняя
- `sourceType: 'external'` - тип источника
- `url` - ссылка на оригинальную статью
- `urlToImage` - ссылка на изображение статьи

## Регистрация пользователей

### Публичная регистрация

- `POST /api/auth/register` - Регистрация нового пользователя (с ролью Reader по умолчанию)

Новые пользователи автоматически получают роль "Reader" и могут сразу войти в систему используя полученный JWT токен.
